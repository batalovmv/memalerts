---
alwaysApply: true
---

### MemAlerts Backend — agent rules (required)

Goal: ship backend changes **fast and safely** without breaking invariants (beta/prod isolation, CSRF boundaries, internal relay, realtime privacy), while **saving tokens** (less “blind reading”, more targeted search and minimal diffs).

---

### TL;DR: what this repo is

- **Backend API**: Express + TypeScript (ESM) → `tsc` builds into `dist/` (**never edit `dist/*` by hand**).
- **Realtime**: Socket.IO (OBS overlays + dashboard/live updates).
- **DB**: PostgreSQL via Prisma.
- **Uploads**: video submissions, SHA‑256 dedup (`FileHash`) + storage `local` or `s3`.

---

### How to work “cheap” on tokens (very important)

- **Find the entry point via search first**:
  - for exact strings/symbols: `grep` (then `read_file` a small slice).
  - for “where is this implemented?”: `codebase_search`, then narrow down to a file.
- **Don’t read huge files end-to-end** (especially `docs/FRONTEND_API_CHEATSHEET.md`) — use `offset/limit` and only the needed section.
- **Don’t touch `dist/*`** — change `src/*`, then run `pnpm build`.
- **Keep diffs minimal**: avoid “drive-by refactors”.
- **Treat `tests/*.test.ts` as contracts**: file names map to invariants we must not break.

---

### Critical invariants (do not break)

#### 1) beta ↔ prod isolation (cookies + secrets + origins)

- **Cookie name**:
  - prod: `token`
  - beta: `token_beta`
- **JWT secret**: `process.env.JWT_SECRET` **must differ** between beta and prod (separate `.env` on the VPS).
- **Beta detection**: never rely only on `Host` (nginx/proxy can rewrite). See:
  - `src/middleware/auth.ts` (`isBetaDomain`, chooses `token_beta`)
  - `src/middleware/csrf.ts` (allowed origins compute “beta instance” via `DOMAIN/PORT/INSTANCE`)
  - `src/socket/index.ts` (socket cookie selection via host/domain).

#### 2) CSRF boundaries

- CSRF is enabled for **POST/PUT/PATCH/DELETE**.
- Explicit exceptions (must stay):
  - `/internal/*` (localhost-only relay)
  - `/webhooks/*` (signatures instead of CSRF)
  - `/health`
  - `/auth/twitch*` (backward-compatible)
  - `/public/*` (guest read/control)
- UX nuance: `POST /auth/logout` may pass without `Origin` **only if** `Sec-Fetch-Site` = `same-site|same-origin`.
- Code: `src/middleware/csrf.ts`.

#### 3) Internal relay (prod ↔ beta on the same VPS)

- Endpoints:
  - `POST /internal/wallet-updated`
  - `POST /internal/submission-event`
  - `POST /internal/credits/chatter`
  - `POST /internal/credits/donor`
- **Security requirements** (do not weaken):
  - source must be **localhost** (`127.0.0.1` / `::1`) → `isLocalhostAddress`
  - header `x-memalerts-internal`:
    - `wallet-updated` (see `src/realtime/walletBridge.ts`)
    - `submission-event` (see `src/realtime/submissionBridge.ts`)
    - credits: `credits-event` (see `src/controllers/internal/creditsInternal.ts`)
- External clients must get **404**, and nginx **must not proxy** `/internal/*`.
- Entry point: `src/routes/index.ts`.

#### 4) Wallet privacy in realtime

- `wallet:updated` must be emitted **only** to room `user:{userId}`.
- Never emit to `channel:*` (leaks balances + duplicates for clients in both rooms).
- Code: `src/realtime/walletBridge.ts`.

#### 5) Slug normalization for channel rooms

- Room name is always `channel:${slug.toLowerCase()}`.
- Code: `src/socket/index.ts`, `src/realtime/submissionBridge.ts` (and activation flow in controllers).

---

### System map: where to look (fast anchors)

- **Bootstrapping**: `src/index.ts` (Express/Socket.IO, middleware, timeouts).
- **Routes**:
  - `src/routes/index.ts` — health, `/public/*`, credits overlay HTML, internal relay endpoints, debug endpoints.
  - `src/routes/auth.ts`, `src/routes/viewer.ts`, `src/routes/submissions.ts`, `src/routes/streamer.ts`, `src/routes/owner.ts`, `src/routes/webhooks.ts`, `src/routes/beta.ts`.
- **Auth / OAuth**:
  - `src/middleware/auth.ts` (JWT cookie selection + beta detection).
  - `src/controllers/authController.ts` (multi-provider login/linking; redirect allowlist; **do NOT `include: { channel: true }`** — migrations may lag; see comment).
  - `src/auth/providers/*` (twitch/youtube/vk/vkvideo/trovo/kick/discord).
- **CSRF**: `src/middleware/csrf.ts`.
- **Socket.IO**: `src/socket/index.ts`:
  - `join:channel` (streamer/admin only, slug must match authenticated user’s channel)
  - `join:user` (only if `userId === auth.userId`)
  - `join:overlay` (overlay JWT only, with token rotation `tv`).
- **Realtime bridges**: `src/realtime/*` (`walletBridge.ts`, `submissionBridge.ts`, credits state/store/ticker).
- **DB/Prisma**: `prisma/schema.prisma`, `src/lib/prisma.ts`.
- **Docs (source of truth)**:
  - `ARCHITECTURE.md` (flows + principles)
  - `DEVELOPMENT.md` (local setup + performance knobs)
  - `DEPLOYMENT.md` and `docs/DEPLOY_DEV.md` (real deploy triggers)
  - `docs/TESTING.md` (how to run tests + what invariants they lock).

---

### API “quick map” (most important)

- **Health**: `GET /health`
- **Public guest API (available to guests on BOTH prod and beta)**:
  - `GET /public/channels/:slug`
  - `GET /public/channels/:slug/memes`
  - `GET /public/channels/:slug/memes/search`
  - token-based control: `GET/POST /public/submissions/*` (protected by query `token`, not cookies)
- **Legacy public (note: beta gating depends on domain/instance)**:
  - `GET /channels/:slug`, `GET /channels/:slug/memes`, `GET /channels/memes/search`, `GET /memes/stats`
- **Viewer (auth)**: `GET /me`, `GET/PATCH /me/preferences`, `GET /wallet`, `GET /memes`, `POST /memes/:id/activate`, `GET /channels/:slug/wallet`
- **Submissions**: `POST /submissions` etc.
- **Streamer**: `/streamer/*` (role `streamer|admin`)
- **Owner**: `/owner/*` (role `admin`)
- **Webhooks**: `/webhooks/*`

Full spec is `docs/FRONTEND_API_CHEATSHEET.md`, but agents must **not** read it fully — only the relevant endpoint section.

---

### Uploads / submissions: security and performance

- Submissions currently: **video only**.
- Limits: size ≤ 50MB; duration ≤ 15s (ffprobe, may fallback to client duration).
- Security: magic-bytes validation + path traversal guards + SHA‑256 dedup (`FileHash`).
- Heavy-work concurrency guards (important under load): `VIDEO_FFPROBE_CONCURRENCY`, `FILE_HASH_CONCURRENCY` (see `ENV.example`, `DEVELOPMENT.md`).
- Storage:
  - `UPLOAD_STORAGE=local` → `UPLOAD_DIR=./uploads` (VPS typically serves via nginx).
  - `UPLOAD_STORAGE=s3` → `FileHash.filePath` is a public URL (`S3_PUBLIC_BASE_URL` + key).

---

### Prisma migrations (shared DB): expand/contract

If beta and prod share a DB (`shared`), migrations must be **backward-compatible** until release:

- **Expand (ok)**: `ADD COLUMN NULL`, new tables, additive indexes.
- **Contract (only after release)**: drop/rename/type changes.
- Guard in repo: `pnpm migrations:check` (see `DEVELOPMENT.md`).

---

### Local commands

- Dev: `pnpm dev`
- Build: `pnpm build`
- Start: `pnpm start`
- Prisma: `pnpm db:migrate`, `pnpm db:seed`, `pnpm db:studio`
- Tests: see `docs/TESTING.md` (`TEST_DATABASE_URL_BASE`, Postgres via `docker-compose.test.yml` on 5433).

---

### Deploy + VPS (ops, when needed)

#### Access

- SSH: `ssh deploy@155.212.172.136`

#### Instances

- production: port **3001**, `/opt/memalerts-backend`, PM2 `memalerts-api`
- beta: port **3002**, `/opt/memalerts-backend-beta`, PM2 `memalerts-api-beta`

#### Deploy triggers (source of truth)

- beta: **push to `main`** → deploy to 3002 (see `docs/DEPLOY_DEV.md`, `DEPLOYMENT.md`).
- production: **push tag `prod-*`** → deploy to 3001 (see `docs/DEPLOY_DEV.md`).

#### PM2 (quick)

- status: `pm2 status`
- logs: `pm2 logs memalerts-api --lines 200` / `pm2 logs memalerts-api-beta --lines 200`
- restart: `pm2 restart memalerts-api` / `pm2 restart memalerts-api-beta`

#### `.env` on VPS

- `.env` lives at `/opt/memalerts-backend/.env` and `/opt/memalerts-backend-beta/.env` and is **not** rsync’ed by deploy.
- Beta/prod secrets (especially `JWT_SECRET`) must be **different**.

---

### Debug endpoints (opt-in only, never on production)

- `DEBUG_LOGS=1` enables `GET /debug-ip` (see `src/routes/index.ts`)
- `DEBUG_AUTH=1` (or `DEBUG_LOGS=1`) enables `GET /debug-auth` (never returns tokens)

---

### Mini checklist before any change

- Am I affecting **beta/prod isolation** (cookie/origins/JWT)?
- Am I changing **CSRF exceptions** (`/public/*`, `/internal/*`, `/webhooks/*`)?
- Am I weakening **localhost-only** + `x-memalerts-internal` for `/internal/*`?
- Am I breaking **wallet privacy** (`wallet:updated` only to `user:{id}`)?
- Am I normalizing `slug` (`toLowerCase`) in channel rooms/events?
- If migrations are involved: **expand/contract**, no destructive SQL in shared DB mode.
