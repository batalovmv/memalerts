# Local development example (DO NOT use in production)

# Database
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/memalerts?schema=public

# Server
PORT=3001
NODE_ENV=development

# Request body limits (uploads are multipart and are not affected by these)
# Production defaults are intentionally tight to avoid memory pressure.
# JSON_BODY_LIMIT=1mb
# URLENCODED_BODY_LIMIT=1mb

# URLs (CORS)
WEB_URL=http://localhost:5173
OVERLAY_URL=http://localhost:5173

# Auth
JWT_SECRET=change-me
JWT_EXPIRES_IN=7d

# Twitch OAuth
TWITCH_CLIENT_ID=your_client_id
TWITCH_CLIENT_SECRET=your_client_secret
TWITCH_CALLBACK_URL=http://localhost:3001/auth/twitch/callback

# YouTube (Google OAuth) — external account linking
YOUTUBE_CLIENT_ID=your_google_client_id
YOUTUBE_CLIENT_SECRET=your_google_client_secret
YOUTUBE_CALLBACK_URL=http://localhost:3001/auth/youtube/link/callback

# YouTube shared bot account (server-side) — sends messages to chat as MemAlerts bot.
# How it works:
# - Streamers link YouTube with read-only scope (youtube.readonly) to let us resolve their channelId and detect LIVE.
# - Sending messages is done with a separate bot Google account refresh token stored in ENV below.
#
# Obtain refresh token for the bot account once (offline access) and paste it here:
# YOUTUBE_BOT_REFRESH_TOKEN=...

# VK OAuth — external account linking
VK_CLIENT_ID=your_vk_client_id
VK_CLIENT_SECRET=your_vk_client_secret
VK_CALLBACK_URL=http://localhost:3001/auth/vk/link/callback

# Trovo OAuth — external account linking
TROVO_CLIENT_ID=your_trovo_client_id
TROVO_CLIENT_SECRET=your_trovo_client_secret
TROVO_CALLBACK_URL=http://localhost:3001/auth/trovo/link/callback
# Optional scopes (space/comma/+ separated). Keep minimal for linking.
# TROVO_SCOPES=
# Optional: token/userinfo endpoints override (defaults match official docs).
# TROVO_TOKEN_URL=https://open-api.trovo.live/openplatform/exchangetoken
# TROVO_REFRESH_URL=https://open-api.trovo.live/openplatform/refreshtoken
# TROVO_USERINFO_URL=https://open-api.trovo.live/openplatform/getuserinfo

# Kick OAuth (official) — external account linking
# See Kick Dev Docs: https://docs.kick.com/
KICK_CLIENT_ID=your_kick_client_id
KICK_CLIENT_SECRET=your_kick_client_secret
KICK_CALLBACK_URL=http://localhost:3001/auth/kick/link/callback
# Kick OAuth 2.1 endpoints (from Kick docs):
# KICK_AUTHORIZE_URL=
# KICK_TOKEN_URL=
# KICK_REFRESH_URL=
# KICK_USERINFO_URL=
# Optional scopes (space/comma/+ separated)
# KICK_SCOPES=

# Kick webhooks (reward redemption updates)
# - Kick validates signatures with RSA (PKCS#1 v1.5), not HMAC.
# - If KICK_WEBHOOK_CALLBACK_URL is not set, backend will derive it from DOMAIN + request host.
# KICK_WEBHOOK_CALLBACK_URL=https://your-domain.com/webhooks/kick/events
# Optional: replay protection window (ms). Default: 10 minutes.
# KICK_WEBHOOK_REPLAY_WINDOW_MS=600000
# Optional: emergency override to avoid fetching public key from Kick API (PEM).
# KICK_WEBHOOK_PUBLIC_KEY_PEM="-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----"

# Twitch EventSub
TWITCH_EVENTSUB_SECRET=your_eventsub_secret

# Uploads
MAX_FILE_SIZE=52428800
UPLOAD_DIR=./uploads

# Heavy-work concurrency guards (protect CPU/IO under bursty uploads)
# VIDEO_FFPROBE_CONCURRENCY=2
# FILE_HASH_CONCURRENCY=2

# Storage provider for deduped meme files (FileHash.filePath stores a public path/URL)
# - local: stores under /uploads/memes/{hash}.{ext} (served by nginx/express static)
# - s3: stores into S3-compatible storage and returns S3_PUBLIC_BASE_URL + key as filePath
# UPLOAD_STORAGE=local
#
# S3-compatible storage (required when UPLOAD_STORAGE=s3)
# S3_BUCKET=your_bucket
# S3_ACCESS_KEY_ID=your_access_key
# S3_SECRET_ACCESS_KEY=your_secret
# S3_PUBLIC_BASE_URL=https://cdn.example.com   # must point to the bucket origin or CDN in front
# Optional:
# S3_ENDPOINT=https://<account>.r2.cloudflarestorage.com  # R2/MinIO endpoint
# S3_REGION=auto
# S3_KEY_PREFIX=memalerts
# S3_FORCE_PATH_STYLE=1

# Optional: Redis (shared cache + Socket.IO scaling)
# REDIS_URL=redis://localhost:6379
#
# Optional: Redis-backed rate limiting (recommended when REDIS_URL is set / multi-instance)
# RATE_LIMIT_REDIS=1

# Optional: AI moderation for upload submissions (disabled by default)
# Notes:
# - For multi-host deployments, do NOT use UPLOAD_STORAGE=local unless /uploads is a shared volume (NFS/volume mount).
#   Otherwise the AI worker may not see the uploaded files.
# - Requires OPENAI_API_KEY for ASR + text moderation when enabled.
#
# AI_MODERATION_ENABLED=1
# AI_MODERATION_INTERVAL_MS=30000
# AI_MODERATION_INITIAL_DELAY_MS=15000
# AI_MODERATION_BATCH=25
# AI_MODERATION_STUCK_MS=900000
# AI_MAX_RETRIES=5
# AI_MODERATION_MEDIUM_THRESHOLD=0.4
# AI_MODERATION_HIGH_THRESHOLD=0.7
# AI_QUARANTINE_DAYS=14
# AI_LOW_AUTOPROVE_ENABLED=0
# AI_PENDING_FILE_RETENTION_HOURS=72
# AI_PENDING_FILE_CLEANUP_INTERVAL_MS=21600000
# AI_PENDING_FILE_CLEANUP_BATCH=200
#
# OPENAI_API_KEY=...
# Optional timeouts (recommended for stability):
# OPENAI_HTTP_TIMEOUT_MS=60000
# AI_FFMPEG_TIMEOUT_MS=90000
# AI_PER_SUBMISSION_TIMEOUT_MS=300000
# If upload-time hashing times out, AI pipeline will compute missing fileHash; this controls its timeout:
# AI_FILEHASH_TIMEOUT_MS=120000
# Optional model overrides:
# OPENAI_ASR_MODEL=gpt-4o-mini-transcribe
# OPENAI_MODERATION_MODEL=omni-moderation-latest

# Optional: Twitch chat bot (collect chatters for credits overlay)
# CHAT_BOT_ENABLED=1
# CHAT_BOT_LOGIN=lotas_bot
# One of:
# CHAT_BOT_USER_ID=<internal user UUID in DB>
# CHAT_BOT_TWITCH_USER_ID=<twitch user id>
# Map Twitch channel login -> memalerts channel slug:
# - Simple (recommended): CHAT_BOT_CHANNELS=lotas:<slug>,another:<slug2>
# - JSON (optional): CHAT_BOT_CHANNEL_MAP_JSON=[{"login":"lotas","slug":"<your-channel-slug>"}]
#
# Optional: Global chat bot runner (DB subscriptions)
# Run separately via: pnpm build && pnpm start:chatbot
# CHATBOT_BACKEND_BASE_URL=http://127.0.0.1:3001
# CHATBOT_SYNC_SECONDS=30
#
# Optional: YouTube chat bot runner (DB subscriptions)
# Run separately via: pnpm build && pnpm start:youtube-chatbot
# NOTE:
# - Streamer linking uses read-only scope only (youtube.readonly).
# - Sending chat messages requires the server-side bot token (YOUTUBE_BOT_REFRESH_TOKEN) with youtube.force-ssl.
# Uses the same internal relay base URLs:
# CHATBOT_BACKEND_BASE_URL=http://127.0.0.1:3001
# YOUTUBE_CHATBOT_SYNC_SECONDS=20
# YOUTUBE_CHATBOT_LIVE_CHECK_SECONDS=20
# YOUTUBE_CHATBOT_COMMANDS_REFRESH_SECONDS=30
# YOUTUBE_CHATBOT_OUTBOX_POLL_MS=1000

# Optional: VKVideo chat bot runner (DB subscriptions)
# Run separately via: pnpm build && pnpm start:vkvideo-chatbot
# VKVIDEO_CHAT_BOT_ENABLED=1
# Uses the same internal relay base URLs:
# CHATBOT_BACKEND_BASE_URL=http://127.0.0.1:3001
# VKVIDEO_API_BASE_URL=https://live.vkvideo.ru (пример; см docs/VKVIDEO_LIVE_API.md)
# VKVIDEO_PUBSUB_WS_URL=wss://pubsub-dev.live.vkvideo.ru/connection/websocket?format=json&cf_protocol_version=v2
# VKVIDEO_CHATBOT_SYNC_SECONDS=30
# VKVIDEO_CHATBOT_OUTBOX_POLL_MS=1000
# VKVIDEO_CHATBOT_COMMANDS_REFRESH_SECONDS=30
# Pubsub connect/subscription token refresh interval (avoid reconnect churn):
# VKVIDEO_PUBSUB_REFRESH_SECONDS=600
# Optional: cache TTL for VKVideo role lookups (only used for role-gated commands):
# VKVIDEO_USER_ROLES_CACHE_TTL_MS=30000
# Optional: roles lookup URL template used by VKVideo chat bot (must include {channelId}/{userId} placeholders):
# VKVIDEO_CHANNEL_ROLES_USER_URL_TEMPLATE=https://apidev.live.vkvideo.ru/v1/channel_roles/user?channel_url={channelId}&user_id={userId}

# Optional: Trovo chat bot runner (DB subscriptions)
# Run separately via: pnpm build && pnpm start:trovo-chatbot
# TROVO_CHAT_BOT_ENABLED=1
# Uses the same internal relay base URLs:
# CHATBOT_BACKEND_BASE_URL=http://127.0.0.1:3001
# TROVO_CHATBOT_SYNC_SECONDS=30
# TROVO_CHATBOT_OUTBOX_POLL_MS=1000
# TROVO_CHATBOT_COMMANDS_REFRESH_SECONDS=30
# Optional overrides:
# TROVO_CHAT_WS_URL=wss://open-chat.trovo.live/chat
# TROVO_CHAT_TOKEN_URL=https://open-api.trovo.live/openplatform/chat/token
# TROVO_SEND_CHAT_URL=https://open-api.trovo.live/openplatform/chat/send
# If you want separate bot sender scopes:
# TROVO_BOT_SCOPES=

# Optional: Kick chat bot runner (DB subscriptions)
# Run separately via: pnpm build && pnpm start:kick-chatbot
# KICK_CHAT_BOT_ENABLED=1
# Uses the same internal relay base URLs:
# CHATBOT_BACKEND_BASE_URL=http://127.0.0.1:3001
# KICK_CHATBOT_SYNC_SECONDS=30
# KICK_CHATBOT_OUTBOX_POLL_MS=1000
# KICK_CHATBOT_COMMANDS_REFRESH_SECONDS=30
# Optional: read chat messages via official API (template; depends on exact Kick Chat API endpoint).
# Provide a URL with placeholders:
# - {channelId} (required)
# - {cursor} (optional)
# Example:
# KICK_CHAT_POLL_URL_TEMPLATE=https://api.kick.com/v1/chat/messages?channel_id={channelId}&cursor={cursor}
# KICK_CHATBOT_INGEST_POLL_MS=1000
# Required to send messages (official chat endpoint):
# KICK_SEND_CHAT_URL=https://api.kick.com/public/v1/chat
# If you want separate bot sender scopes:
# KICK_BOT_SCOPES=

# Rollups (performance)
# Daily rollup (per-channel): aggregates MemeActivation by day (used by /streamer/stats/channel daily chart)
# CHANNEL_DAILY_STATS_ROLLUP_DAYS=45
# CHANNEL_DAILY_STATS_ROLLUP_INTERVAL_MS=300000
# CHANNEL_DAILY_STATS_ROLLUP_INITIAL_DELAY_MS=60000
#
# Top stats rollup (30d window): replaces heavy groupBy for top users/memes and viewer monthly stats
# TOP_STATS_30D_ROLLUP_DAYS=30
# TOP_STATS_30D_ROLLUP_INTERVAL_MS=300000
# TOP_STATS_30D_ROLLUP_INITIAL_DELAY_MS=90000
#
# Meme daily rollup (viewer day/week stats, and can be used to assemble month/year if needed)
# MEME_DAILY_STATS_ROLLUP_DAYS=45
# MEME_DAILY_STATS_ROLLUP_INTERVAL_MS=300000
# MEME_DAILY_STATS_ROLLUP_INITIAL_DELAY_MS=75000

# Optional tuning
# LOG_LEVEL=debug
# HTTP_COMPRESSION=1
# SEARCH_PAGE_MAX=50
# SEARCH_CACHE_MS=30000
# MEME_STATS_CACHE_MS=30000
# PROMO_CACHE_MS=5000

# Boosty rewards scheduler (coins for subscribers)
# Choose subscription detection source:
# - boosty_api: uses linked Boosty token per user and calls Boosty API
# - discord_roles: uses Discord tier roles membership in the platform guild (Boosty assigns roles)
# BOOSTY_REWARDS_MODE=boosty_api
BOOSTY_REWARDS_MODE=discord_roles
BOOSTY_REWARDS_SYNC_INTERVAL_MS=300000
BOOSTY_REWARDS_SYNC_INITIAL_DELAY_MS=60000
BOOSTY_REWARDS_SUBSCRIPTIONS_LIMIT=200
# Optional: Boosty API base URL override
# BOOSTY_API_BASE_URL=https://api.boosty.to

# Discord OAuth (external account linking; link-only provider)
DISCORD_CLIENT_ID=your_discord_client_id
DISCORD_CLIENT_SECRET=your_discord_client_secret
DISCORD_CALLBACK_URL=http://localhost:3001/auth/discord/link/callback
# Optional: override OAuth scopes for Discord linking.
# Default: "identify". If DISCORD_AUTO_JOIN_GUILD=1, backend will also request "guilds.join" when possible.
# Examples: "identify guilds.join"
# DISCORD_JOIN_SCOPES=identify guilds.join
# Optional endpoint overrides:
# DISCORD_TOKEN_URL=https://discord.com/api/oauth2/token
# DISCORD_USERINFO_URL=https://discord.com/api/users/@me

# Discord bot (used to read member roles; and optionally auto-join users to the guild)
DISCORD_DEFAULT_SUBSCRIPTIONS_GUILD_ID=your_guild_id
# Legacy fallback (pre-multi-guild):
# DISCORD_SUBSCRIPTIONS_GUILD_ID=your_guild_id
DISCORD_BOT_TOKEN=your_bot_token
# If enabled and OAuth scope includes guilds.join, backend will best-effort add the user to the guild after linking.
DISCORD_AUTO_JOIN_GUILD=1
# Optional: cache guild member role lookups (ms)
# DISCORD_MEMBER_CACHE_TTL_MS=15000
# Optional: HTTP timeout for Discord calls (ms)
# DISCORD_HTTP_TIMEOUT_MS=10000

