# Local development example (DO NOT use in production)

# Database
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/memalerts?schema=public
# SKIP_DB_CONNECT=1

# Server
PORT=3001
NODE_ENV=development
# Graceful shutdown (ms)
# SHUTDOWN_TIMEOUT_MS=30000
# HTTP_DRAIN_TIMEOUT_MS=10000

# Request body limits (uploads are multipart and are not affected by these)
# Production defaults are intentionally tight to avoid memory pressure.
# JSON_BODY_LIMIT=1mb
# URLENCODED_BODY_LIMIT=1mb

# URLs (CORS)
WEB_URL=http://localhost:5173
OVERLAY_URL=http://localhost:5173

# API deprecation headers (legacy unversioned routes)
# DEPRECATION_ENABLED=1
# DEPRECATION_SUNSET=Wed, 21 Oct 2026 07:28:00 GMT
# DEPRECATION_SUCCESSOR=/api/v1

# Auth
JWT_SECRET=change-me
# Optional: previous JWT secret during rotation window
# JWT_SECRET_PREVIOUS=old-secret
JWT_EXPIRES_IN=7d

# Twitch OAuth
TWITCH_CLIENT_ID=your_client_id
TWITCH_CLIENT_SECRET=your_client_secret
TWITCH_CALLBACK_URL=http://localhost:3001/auth/twitch/callback

# YouTube (Google OAuth) — external account linking
YOUTUBE_CLIENT_ID=your_google_client_id
YOUTUBE_CLIENT_SECRET=your_google_client_secret
YOUTUBE_CALLBACK_URL=http://localhost:3001/auth/youtube/link/callback

# YouTube shared bot account (server-side) — sends messages to chat as MemAlerts bot.
# How it works:
# - Streamers link YouTube with read-only scope (youtube.readonly) to let us resolve their channelId and detect LIVE.
# - Sending messages is done with a separate bot Google account refresh token stored in ENV below.
#
# Obtain refresh token for the bot account once (offline access) and paste it here:
# YOUTUBE_BOT_REFRESH_TOKEN=...

# VK OAuth — external account linking
VK_CLIENT_ID=your_vk_client_id
VK_CLIENT_SECRET=your_vk_client_secret
VK_CALLBACK_URL=http://localhost:3001/auth/vk/link/callback

# Twitch EventSub
TWITCH_EVENTSUB_SECRET=your_eventsub_secret

# Uploads
MAX_FILE_SIZE=52428800
UPLOAD_DIR=./uploads

# Heavy-work concurrency guards (protect CPU/IO under bursty uploads)
# VIDEO_FFPROBE_CONCURRENCY=2
# FILE_HASH_CONCURRENCY=2
# VIDEO_TRANSCODE_CONCURRENCY=1

# Upload video normalization (golden playback format)
# Target format: MP4 (H.264/AAC)
# VIDEO_TRANSCODE_TIMEOUT_MS=90000
# VIDEO_MAX_WIDTH=1920
# VIDEO_MAX_HEIGHT=1080
# VIDEO_MAX_FPS=30

# Storage provider for deduped meme files (FileHash.filePath stores a public path/URL)
# - local: stores under /uploads/memes/{hash}.{ext} (served by nginx/express static)
# - s3: stores into S3-compatible storage and returns S3_PUBLIC_BASE_URL + key as filePath
# UPLOAD_STORAGE=local
#
# S3-compatible storage (required when UPLOAD_STORAGE=s3)
# S3_BUCKET=your_bucket
# S3_ACCESS_KEY_ID=your_access_key
# S3_SECRET_ACCESS_KEY=your_secret
# S3_PUBLIC_BASE_URL=https://cdn.example.com   # must point to the bucket origin or CDN in front
# Optional:
# S3_ENDPOINT=https://<account>.r2.cloudflarestorage.com  # R2/MinIO endpoint
# S3_REGION=auto
# S3_KEY_PREFIX=memalerts
# S3_FORCE_PATH_STYLE=1

# Optional: Redis (shared cache + Socket.IO scaling)
# REDIS_URL=redis://localhost:6379
#
# Optional: Redis-backed rate limiting (recommended when REDIS_URL is set / multi-instance)
# RATE_LIMIT_REDIS=1
#
# Optional: trusted reverse proxies for IP detection (comma-separated)
# TRUSTED_PROXY_IPS=127.0.0.1,10.0.0.1
#
# Optional: BullMQ queue prefix override (defaults to memalerts:prod|beta)
# BULLMQ_PREFIX=memalerts:prod

# Optional: AI moderation for upload submissions (disabled by default)
# Notes:
# - For multi-host deployments, do NOT use UPLOAD_STORAGE=local unless /uploads is a shared volume (NFS/volume mount).
#   Otherwise the AI worker may not see the uploaded files.
# - Requires OPENAI_API_KEY for ASR + text moderation when enabled.
#
# AI_MODERATION_STUCK_MS=900000
# AI_MAX_RETRIES=5
# AI_MODERATION_MEDIUM_THRESHOLD=0.4
# AI_MODERATION_HIGH_THRESHOLD=0.7
# AI_QUARANTINE_DAYS=14
# AI_LOW_AUTOPROVE_ENABLED=0
# AI_AUTO_APPROVE_ENABLED=0
# AI_AUTO_APPROVE_MAX_RISK=0.2
# AI_AUTO_APPROVE_MAX_DURATION_MS=90000
# AI_AUTO_APPROVE_BLOCKED_TAGS=nsfw,porn,nude,sex,sexual,adult,explicit,gore,violence,hate,racism
# AI_AUTO_APPROVE_BLOCKED_LABELS=low_confidence
# AI_AUTO_APPROVE_BLOCKED_LABEL_PREFIXES=text:,kw:
# QUALITY_SCORE_ENABLED=1
# QUALITY_SCORE_WINDOW_DAYS=30
# QUALITY_SCORE_RECENCY_DAYS=20
# QUALITY_SCORE_ENGAGEMENT_MULTIPLIER=2
# QUALITY_SCORE_MAX_SCORE=100
# TAG_AI_VALIDATION_ENABLED=1
# TAG_AI_VALIDATION_MODEL=gpt-4o-mini
# QUALITY_SCORE_INTERVAL_MS=86400000
# QUALITY_SCORE_INITIAL_DELAY_MS=60000
# DUPLICATE_MERGE_ENABLED=1
# DUPLICATE_MERGE_INTERVAL_MS=86400000
# DUPLICATE_MERGE_INITIAL_DELAY_MS=300000
# HEALTH_MONITOR_ENABLED=1
# HEALTH_MONITOR_INTERVAL_MS=300000
# HEALTH_MONITOR_INITIAL_DELAY_MS=60000
# HEALTH_AI_STUCK_MS=1800000
# HEALTH_DISK_PATH=/
# HEALTH_DISK_MIN_BYTES=5368709120
# HEALTH_AI_ERROR_WINDOW_MS=300000
# HEALTH_AI_ERROR_MAX=100
# HEALTH_ALERT_COOLDOWN_MS=600000
# ALERTS_TELEGRAM_ENABLED=1
# ALERTS_TELEGRAM_BOT_TOKEN=
# ALERTS_TELEGRAM_CHAT_ID=
# ALERTS_TELEGRAM_PREFIX=
# AI_PENDING_FILE_RETENTION_HOURS=72
# AI_PENDING_FILE_CLEANUP_INTERVAL_MS=21600000
# AI_PENDING_FILE_CLEANUP_BATCH=200
#
# Optional: AI metadata generation (title/tags/description) and vision frames
# AI_METADATA_ENABLED=1
# AI_VISION_ENABLED=1
# AI_VISION_MAX_FRAMES=8
# AI_VISION_STEP_SECONDS=2
#
# Optional: BullMQ-based AI worker (horizontal scaling + persistence). Requires REDIS_URL.
# AI_BULLMQ_ENABLED=1
# AI_BULLMQ_CONCURRENCY=2
#
# OPENAI_API_KEY=...
# Optional timeouts (recommended for stability):
# OPENAI_HTTP_TIMEOUT_MS=60000
# AI_FFMPEG_TIMEOUT_MS=90000
# AI_PER_SUBMISSION_TIMEOUT_MS=300000
# AI_LOCK_TTL_MS=480000
# If upload-time hashing times out, AI pipeline will compute missing fileHash; this controls its timeout:
# AI_FILEHASH_TIMEOUT_MS=120000
# Optional model overrides:
# OPENAI_ASR_MODEL=gpt-4o-mini-transcribe
# OPENAI_MODERATION_MODEL=omni-moderation-latest

# Optional: BullMQ chat outbox worker (reliable bot message delivery). Requires REDIS_URL.
# CHAT_OUTBOX_BULLMQ_ENABLED=1
# CHAT_OUTBOX_MAX_ATTEMPTS=5
# CHAT_OUTBOX_CHANNEL_LOCK_TTL_MS=30000
# CHAT_OUTBOX_LOCK_DELAY_MS=1000
# CHAT_OUTBOX_PROCESSING_STALE_MS=60000
# Per-platform worker settings:
# TWITCH_CHAT_OUTBOX_CONCURRENCY=2
# TWITCH_CHAT_OUTBOX_RATE_LIMIT_MAX=20
# TWITCH_CHAT_OUTBOX_RATE_LIMIT_WINDOW_MS=30000
# YOUTUBE_CHAT_OUTBOX_CONCURRENCY=2
# YOUTUBE_CHAT_OUTBOX_RATE_LIMIT_MAX=10
# YOUTUBE_CHAT_OUTBOX_RATE_LIMIT_WINDOW_MS=30000
# VKVIDEO_CHAT_OUTBOX_CONCURRENCY=2
# VKVIDEO_CHAT_OUTBOX_RATE_LIMIT_MAX=20
# VKVIDEO_CHAT_OUTBOX_RATE_LIMIT_WINDOW_MS=30000

# Optional: Twitch chat bot (legacy sender/outbox support)
# CHAT_BOT_ENABLED=1
# CHAT_BOT_LOGIN=lotas_bot
# One of:
# CHAT_BOT_USER_ID=<internal user UUID in DB>
# CHAT_BOT_TWITCH_USER_ID=<twitch user id>
# Map Twitch channel login -> memalerts channel slug:
# - Simple (recommended): CHAT_BOT_CHANNELS=lotas:<slug>,another:<slug2>
# - JSON (optional): CHAT_BOT_CHANNEL_MAP_JSON=[{"login":"lotas","slug":"<your-channel-slug>"}]
#
# Optional: Global chat bot runner (DB subscriptions)
# Run separately via: pnpm build && pnpm start:chatbot
# CHATBOT_BACKEND_BASE_URL=http://127.0.0.1:3001
# CHATBOT_BACKEND_BASE_URLS=http://127.0.0.1:3001
# CHATBOT_SYNC_SECONDS=30
# CHATBOT_OUTBOX_POLL_MS=1000
#
# Optional: YouTube chat bot runner (DB subscriptions)
# Run separately via: pnpm build && pnpm start:youtube-chatbot
# NOTE:
# - Streamer linking uses read-only scope only (youtube.readonly).
# - Sending chat messages requires the server-side bot token (YOUTUBE_BOT_REFRESH_TOKEN) with youtube.force-ssl.
# Uses the same internal relay base URLs:
# CHATBOT_BACKEND_BASE_URL=http://127.0.0.1:3001
# CHATBOT_BACKEND_BASE_URLS=http://127.0.0.1:3001
# YOUTUBE_CHATBOT_SYNC_SECONDS=20
# YOUTUBE_CHATBOT_LIVE_CHECK_SECONDS=20
# YOUTUBE_CHATBOT_OUTBOX_POLL_MS=1000

# Optional: VKVideo chat bot runner (DB subscriptions)
# Run separately via: pnpm build && pnpm start:vkvideo-chatbot
# VKVIDEO_CHAT_BOT_ENABLED=1
# Uses the same internal relay base URLs:
# CHATBOT_BACKEND_BASE_URL=http://127.0.0.1:3001
# CHATBOT_BACKEND_BASE_URLS=http://127.0.0.1:3001
# VKVIDEO_API_BASE_URL=https://live.vkvideo.ru (пример; см docs/VKVIDEO_LIVE_API.md)
# VKVIDEO_PUBSUB_WS_URL=wss://pubsub-dev.live.vkvideo.ru/connection/websocket?format=json&cf_protocol_version=v2
# VKVIDEO_CHATBOT_SYNC_SECONDS=30
# VKVIDEO_CHATBOT_OUTBOX_POLL_MS=1000
# Pubsub connect/subscription token refresh interval (avoid reconnect churn):
# VKVIDEO_PUBSUB_REFRESH_SECONDS=600

# Rollups (performance)
# Daily rollup (per-channel): aggregates MemeActivation by day (used by /streamer/stats/channel daily chart)
# CHANNEL_DAILY_STATS_ROLLUP_DAYS=45
# CHANNEL_DAILY_STATS_ROLLUP_INTERVAL_MS=3600000
# CHANNEL_DAILY_STATS_ROLLUP_INITIAL_DELAY_MS=60000
#
# Top stats rollup (30d window): replaces heavy groupBy for top users/memes and viewer monthly stats
# TOP_STATS_30D_ROLLUP_DAYS=30
# TOP_STATS_30D_ROLLUP_INTERVAL_MS=7200000
# TOP_STATS_30D_ROLLUP_INITIAL_DELAY_MS=90000
#
# Meme daily rollup (viewer day/week stats, and can be used to assemble month/year if needed)
# MEME_DAILY_STATS_ROLLUP_DAYS=45
# MEME_DAILY_STATS_ROLLUP_INTERVAL_MS=3600000
# MEME_DAILY_STATS_ROLLUP_INITIAL_DELAY_MS=75000

# Optional tuning
# DB_SLOW_MS=500
# LOG_LEVEL=debug
# INSTANCE_ID=api-1
# LOG_DESTINATION=./logs/memalerts-api.log
# LOG_TRANSPORT_TARGET=pino/file
# LOG_TRANSPORT_OPTIONS={"destination":"./logs/memalerts-api.log","mkdir":true}
# LOG_TRANSPORT_LEVEL=info
# HTTP_COMPRESSION=1
# SEARCH_PAGE_MAX=50
# SEARCH_CACHE_MS=30000
# MEME_STATS_CACHE_MS=30000
# PROMO_CACHE_MS=5000

# Observability (tracing + error tracking)
# OTEL_ENABLED=1
# OTEL_EXPORTER_JAEGER_ENDPOINT=http://localhost:14268/api/traces
# OTEL_EXPORTER_JAEGER_AGENT_HOST=
# OTEL_EXPORTER_JAEGER_AGENT_PORT=
# OTEL_SUCCESS_SAMPLE_RATE=0.1
# OTEL_TRACE_MAX_MS=300000
# OTEL_TRACE_DECISION_TTL_MS=300000
# OTEL_DIAG_LOGS=0
# SENTRY_DSN=
# SENTRY_RELEASE=

# Resilience (external HTTP)
# Per-service HTTP timeouts (ms):
# TWITCH_HTTP_TIMEOUT_MS=10000
# YOUTUBE_HTTP_TIMEOUT_MS=10000
# OPENAI_HTTP_TIMEOUT_MS=60000
#
# Per-service retry policy (exponential backoff):
# {SERVICE}_RETRY_MAX_ATTEMPTS=3
# {SERVICE}_RETRY_BASE_DELAY_MS=500
# {SERVICE}_RETRY_MAX_DELAY_MS=3000
#
# Per-service circuit breaker tuning:
# {SERVICE}_CIRCUIT_FAILURE_THRESHOLD=5
# {SERVICE}_CIRCUIT_RESET_TIMEOUT_MS=30000
# {SERVICE}_CIRCUIT_SUCCESS_THRESHOLD=1
# {SERVICE}_CIRCUIT_HALF_OPEN_MAX_IN_FLIGHT=1
