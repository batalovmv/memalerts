<h1 id="vkpl-devapi---websocket-">WebSocket</h1>

Через WebSocket в первую очередь доставляются события, которые отвечают следующим критериям:
* задержка во времени доставки критична
* события высокочастотные
* потеря сообщений не критична

Система работы с WebSocket базируется на https://centrifugal.dev/

Для работы с ней можно использовать готовые [клиенты](https://centrifugal.dev/docs/4/transports/client_sdk), либо реализовать свой в соответствие с [протоколом](https://centrifugal.dev/docs/4/transports/client_protocol).

На текущий момент в проекте используется Centrifugo V4. Поэтому следует использовать клиентский библиотеки совместимые с указанной версией!

## Процесс работы

Процесс работы с WebSocket можно разбить на следующие шаги:
* получение JWT для подключения к pubsub-dev.live.vkvideo.ru (через вызов метода DevAPI - **GET /websocket/token**)
* подключение к **wss://pubsub-dev.live.vkvideo.ru/connection/websocket?format=json&cf_protocol_version=v2** (через вызов методов CentrifugoAPI)
* получение имен каналов (через вызов методов DevAPI, в зависимости от решаемой задачи)
* подписка на каналы (через вызов методов CentrifugoAPI)
* получение и обработка потока событий

### Подписка на WS-каналы

В большинстве случаев, подписка на канал доступна всем пользователям без дополнительных манипуляций.

Но есть каналы с ограниченным доступом (limited). Для подписки на такие каналы требуется предварительно получить подписочный JWT-токен, через вызов метода DevAPI - **GET /websocket/subscription_token**.

Если DevAPI по какой либо причине не возвращает токен для запрашиваемого канала - это означает что у пользователя нет доступа к данному каналу.

## Формат событий

События передаваемые через WebSocket имеют формат JSON-объектов.

Если опустить общую часть для всех сообщений в Centrifugo, то полезная нагрузка, которая передается в событиях имеет следующий вид:

|Поле|Описание|Комментарии|
|---|---|---|
|type|Тип события|Некоторая строковая константа, значение которой можно узнать в документации по событиям|
|data|Полезная нагрузка события|Некоторый JSON-объект, структура которого зависит от типа события. Детали можно узнать в документации по событиям|
