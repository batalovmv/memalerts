generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Channel {
  id                String   @id @default(uuid())
  twitchChannelId   String   @unique
  slug              String   @unique
  name              String
  rewardIdForCoins  String?
  coinPerPointRatio Float    @default(1.0)
  createdAt         DateTime @default(now())

  users         User[]
  memes         Meme[]
  submissions   MemeSubmission[]
  redemptions   Redemption[]
  activations   MemeActivation[]
  auditLogs     AuditLog[]
}

model User {
  id          String    @id @default(uuid())
  twitchUserId String   @unique
  displayName String
  role        String    // viewer, streamer, admin
  channelId   String?
  createdAt   DateTime  @default(now())

  channel         Channel?          @relation(fields: [channelId], references: [id], onDelete: SetNull)
  wallet          Wallet?
  memesCreated    Meme[]            @relation("CreatedBy")
  memesApproved   Meme[]            @relation("ApprovedBy")
  submissions     MemeSubmission[]
  redemptions     Redemption[]
  activations     MemeActivation[]
  auditLogs       AuditLog[]

  @@index([twitchUserId])
  @@index([channelId])
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Meme {
  id              String    @id @default(uuid())
  channelId       String
  title           String
  type            String    // image, gif, video, audio
  fileUrl         String
  durationMs      Int
  priceCoins      Int
  status          String    // pending, approved, rejected
  createdByUserId String?
  approvedByUserId String?
  createdAt       DateTime  @default(now())

  channel       Channel         @relation(fields: [channelId], references: [id], onDelete: Cascade)
  createdBy     User?           @relation("CreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  approvedBy    User?           @relation("ApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  activations   MemeActivation[]

  @@index([channelId])
  @@index([status])
  @@index([createdByUserId])
}

model MemeSubmission {
  id             String    @id @default(uuid())
  channelId      String
  submitterUserId String
  title          String
  type           String    // image, gif, video, audio
  fileUrlTemp    String
  notes          String?
  status         String    // pending, approved, rejected
  moderatorNotes String?
  createdAt      DateTime  @default(now())

  channel    Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  submitter  User    @relation(fields: [submitterUserId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([status])
  @@index([submitterUserId])
}

model Redemption {
  id               String   @id @default(uuid())
  channelId        String
  userId           String
  twitchRedemptionId String @unique
  pointsSpent      Int
  coinsGranted     Int
  status           String   // pending, completed, failed
  createdAt        DateTime @default(now())

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([userId])
  @@index([twitchRedemptionId])
}

model MemeActivation {
  id         String   @id @default(uuid())
  channelId  String
  userId     String
  memeId     String
  coinsSpent Int
  status     String   // queued, playing, done, failed
  createdAt  DateTime @default(now())

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  meme    Meme    @relation(fields: [memeId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([userId])
  @@index([status])
  @@index([memeId])
}

model AuditLog {
  id         String    @id @default(uuid())
  actorId    String?
  channelId  String
  action     String
  payloadJson String   @db.Text
  createdAt  DateTime  @default(now())

  actor   User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)
  channel Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([actorId])
  @@index([createdAt])
}


