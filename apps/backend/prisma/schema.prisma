generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Channel {
  id                String   @id @default(uuid())
  twitchChannelId   String   @unique
  slug              String   @unique
  name              String
  rewardIdForCoins  String?
  coinPerPointRatio Float    @default(1.0)
  rewardEnabled     Boolean  @default(false)  // Is reward enabled/active
  rewardTitle       String?  // Title of the reward in Twitch
  rewardCost        Int?     // Cost in channel points
  rewardCoins       Int?     // Coins granted per redemption
  primaryColor      String?  // Hex color for primary theme
  secondaryColor    String?  // Hex color for secondary theme
  accentColor       String?  // Hex color for accent
  createdAt         DateTime @default(now())

  users         User[]
  wallets       Wallet[]
  memes         Meme[]
  submissions   MemeSubmission[]
  redemptions   Redemption[]
  activations   MemeActivation[]
  auditLogs     AuditLog[]
  promotions    Promotion[]
}

model User {
  id          String    @id @default(uuid())
  twitchUserId String   @unique
  displayName String
  role        String    // viewer, streamer, admin
  channelId   String?
  twitchAccessToken String?  // Twitch OAuth access token for API calls
  twitchRefreshToken String?  // Twitch OAuth refresh token
  createdAt   DateTime  @default(now())

  channel         Channel?          @relation(fields: [channelId], references: [id], onDelete: SetNull)
  wallets         Wallet[]
  memesCreated    Meme[]            @relation("CreatedBy")
  memesApproved   Meme[]            @relation("ApprovedBy")
  submissions     MemeSubmission[]
  redemptions     Redemption[]
  activations     MemeActivation[]
  auditLogs       AuditLog[]

  @@index([twitchUserId])
  @@index([channelId])
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String
  channelId String
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
  @@index([userId])
  @@index([channelId])
}

model Meme {
  id              String    @id @default(uuid())
  channelId       String
  title           String
  type            String    // image, gif, video, audio
  fileUrl         String
  fileHash        String?   // SHA-256 hash for deduplication
  durationMs      Int
  priceCoins      Int
  status          String    // pending, approved, rejected
  createdByUserId String?
  approvedByUserId String?
  createdAt       DateTime  @default(now())

  channel       Channel         @relation(fields: [channelId], references: [id], onDelete: Cascade)
  createdBy     User?           @relation("CreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  approvedBy    User?           @relation("ApprovedBy", fields: [approvedByUserId], references: [id], onDelete: SetNull)
  activations   MemeActivation[]
  tags          MemeTag[]
  fileHashRef   FileHash?       @relation(fields: [fileHash], references: [hash], onDelete: SetNull)

  @@index([channelId])
  @@index([status])
  @@index([createdByUserId])
  @@index([fileHash])
}

model MemeSubmission {
  id             String    @id @default(uuid())
  channelId      String
  submitterUserId String
  title          String
  type           String    // image, gif, video, audio
  fileUrlTemp    String
  sourceUrl      String?   // URL of imported meme from memalerts.com
  notes          String?
  status         String    // pending, approved, rejected
  moderatorNotes String?
  createdAt      DateTime  @default(now())

  channel    Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  submitter  User    @relation(fields: [submitterUserId], references: [id], onDelete: Cascade)
  tags       MemeSubmissionTag[]

  @@index([channelId])
  @@index([status])
  @@index([submitterUserId])
}

model Redemption {
  id               String   @id @default(uuid())
  channelId        String
  userId           String
  twitchRedemptionId String @unique
  pointsSpent      Int
  coinsGranted     Int
  status           String   // pending, completed, failed
  createdAt        DateTime @default(now())

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([userId])
  @@index([twitchRedemptionId])
}

model MemeActivation {
  id         String   @id @default(uuid())
  channelId  String
  userId     String
  memeId     String
  coinsSpent Int
  status     String   // queued, playing, done, failed
  createdAt  DateTime @default(now())

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  meme    Meme    @relation(fields: [memeId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([userId])
  @@index([status])
  @@index([memeId])
}

model AuditLog {
  id         String    @id @default(uuid())
  actorId    String?
  channelId  String
  action     String
  payloadJson String   @db.Text
  createdAt  DateTime  @default(now())

  actor   User?    @relation(fields: [actorId], references: [id], onDelete: SetNull)
  channel Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([actorId])
  @@index([createdAt])
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())

  memes         MemeTag[]
  submissions   MemeSubmissionTag[]

  @@index([name])
}

model MemeTag {
  id     String @id @default(uuid())
  memeId String
  tagId  String

  meme Meme @relation(fields: [memeId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([memeId, tagId])
  @@index([memeId])
  @@index([tagId])
}

model MemeSubmissionTag {
  id             String @id @default(uuid())
  submissionId   String
  tagId          String

  submission MemeSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  tag        Tag            @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([submissionId, tagId])
  @@index([submissionId])
  @@index([tagId])
}

model Promotion {
  id              String   @id @default(uuid())
  channelId       String
  name            String
  discountPercent Float    // 0-100, e.g., 50 for 50% discount
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([isActive])
  @@index([startDate, endDate])
}

model FileHash {
  hash           String   @id // SHA-256 hash
  filePath       String   // Path to physical file
  referenceCount Int      @default(1) // Number of references to this file
  fileSize       BigInt   // File size in bytes
  mimeType       String   // MIME type of the file
  createdAt      DateTime @default(now())

  memes Meme[]

  @@index([referenceCount])
}


