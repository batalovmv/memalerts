name: Backend Deploy (Self-hosted)

on:
  push:
    branches: [main]
    tags: ['prod-*']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test (self-hosted)
    runs-on: [self-hosted, linux, x64, memalerts-vps]
    timeout-minutes: 15
    env:
      NODE_ENV: test
      JWT_SECRET: test_jwt_secret
      TEST_DATABASE_URL_BASE: postgresql://postgres:postgres@localhost:5433/memalerts_test

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: memalerts_test
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d memalerts_test"
          --health-interval 3s
          --health-timeout 3s
          --health-retries 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install deps
        shell: bash
        run: |
          set -euo pipefail
          pnpm install --frozen-lockfile
          pnpm prisma generate

      - name: Wait for Postgres
        shell: bash
        run: |
          set -euo pipefail
          for i in $(seq 1 40); do
            if (echo > /dev/tcp/127.0.0.1/5433) >/dev/null 2>&1; then
              echo "✅ Postgres port open"
              exit 0
            fi
            sleep 1
          done
          echo "❌ Postgres did not become ready"
          exit 1

      - name: Run tests
        shell: bash
        run: |
          set -euo pipefail
          cd "$GITHUB_WORKSPACE"
          pnpm test:ci

  deploy-production:
    name: Deploy production on VPS (self-hosted)
    runs-on: [self-hosted, linux, x64, memalerts-vps]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/prod-')
    needs: [test]
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # We need origin/main to validate that production release is cut from beta HEAD.
          fetch-depth: 0

      - name: Guard: production tag must point to beta (main) HEAD
        shell: bash
        run: |
          set -euo pipefail

          git fetch origin main --prune

          MAIN_SHA="$(git rev-parse origin/main)"
          TAG_SHA="${GITHUB_SHA}"

          echo "origin/main = ${MAIN_SHA}"
          echo "tag commit  = ${TAG_SHA}"

          if [ "${MAIN_SHA}" != "${TAG_SHA}" ]; then
            echo "❌ Refusing production deploy: prod tag must point to current origin/main (beta HEAD)."
            echo "   This prevents deploying an older commit than beta (and avoids branch drift)."
            exit 1
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Deploy production (build + migrate + restart)
        shell: bash
        run: |
          set -euo pipefail

          APP_DIR="/opt/memalerts-backend"
          PM2_NAME="memalerts-api"

          if [ ! -d "$APP_DIR" ]; then
            echo "❌ $APP_DIR not found. Create it on VPS first."
            exit 1
          fi

          if [ ! -f "$APP_DIR/.env" ]; then
            echo "❌ $APP_DIR/.env not found. Create it on VPS first (prod env)."
            exit 1
          fi

          echo "Syncing repo -> $APP_DIR ..."
          sudo rsync -a --delete \
            --exclude node_modules \
            --exclude uploads \
            --exclude .env \
            ./ "$APP_DIR/"

          cd "$APP_DIR"

          # Optional env sync from GitHub Secrets -> VPS .env (non-destructive upsert).
          # NOTE: The workflow intentionally excludes .env from rsync, so values must exist on VPS.
          # If you manage some envs via GitHub Secrets, add them here explicitly.

          # OpenAI (AI moderation)
          if [ -n "${{ secrets.AI_MODERATION_ENABLED }}" ]; then
            KEY="AI_MODERATION_ENABLED"
            VAL="${{ secrets.AI_MODERATION_ENABLED }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            KEY="OPENAI_API_KEY"
            VAL="${{ secrets.OPENAI_API_KEY }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.OPENAI_BASE_URL }}" ]; then
            KEY="OPENAI_BASE_URL"
            VAL="${{ secrets.OPENAI_BASE_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.OPENAI_ASR_MODEL }}" ]; then
            KEY="OPENAI_ASR_MODEL"
            VAL="${{ secrets.OPENAI_ASR_MODEL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.VKVIDEO_PUBSUB_REFRESH_SECONDS }}" ]; then
            KEY="VKVIDEO_PUBSUB_REFRESH_SECONDS"
            VAL="${{ secrets.VKVIDEO_PUBSUB_REFRESH_SECONDS }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi

          # Trovo OAuth (prod)
          if [ -n "${{ secrets.TROVO_CLIENT_ID }}" ]; then
            KEY="TROVO_CLIENT_ID"
            VAL="${{ secrets.TROVO_CLIENT_ID }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_CLIENT_SECRET }}" ]; then
            KEY="TROVO_CLIENT_SECRET"
            VAL="${{ secrets.TROVO_CLIENT_SECRET }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_CALLBACK_URL }}" ]; then
            KEY="TROVO_CALLBACK_URL"
            VAL="${{ secrets.TROVO_CALLBACK_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_BOT_SCOPES }}" ]; then
            KEY="TROVO_BOT_SCOPES"
            VAL="${{ secrets.TROVO_BOT_SCOPES }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_SCOPES }}" ]; then
            KEY="TROVO_SCOPES"
            VAL="${{ secrets.TROVO_SCOPES }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_TOKEN_URL }}" ]; then
            KEY="TROVO_TOKEN_URL"
            VAL="${{ secrets.TROVO_TOKEN_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_REFRESH_URL }}" ]; then
            KEY="TROVO_REFRESH_URL"
            VAL="${{ secrets.TROVO_REFRESH_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_USERINFO_URL }}" ]; then
            KEY="TROVO_USERINFO_URL"
            VAL="${{ secrets.TROVO_USERINFO_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi

          # Kick OAuth (prod)
          if [ -n "${{ secrets.KICK_CLIENT_ID }}" ]; then
            KEY="KICK_CLIENT_ID"
            VAL="${{ secrets.KICK_CLIENT_ID }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_CLIENT_SECRET }}" ]; then
            KEY="KICK_CLIENT_SECRET"
            VAL="${{ secrets.KICK_CLIENT_SECRET }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_CALLBACK_URL }}" ]; then
            KEY="KICK_CALLBACK_URL"
            VAL="${{ secrets.KICK_CALLBACK_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_AUTHORIZE_URL }}" ]; then
            KEY="KICK_AUTHORIZE_URL"
            VAL="${{ secrets.KICK_AUTHORIZE_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_TOKEN_URL }}" ]; then
            KEY="KICK_TOKEN_URL"
            VAL="${{ secrets.KICK_TOKEN_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_REFRESH_URL }}" ]; then
            KEY="KICK_REFRESH_URL"
            VAL="${{ secrets.KICK_REFRESH_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_USERINFO_URL }}" ]; then
            KEY="KICK_USERINFO_URL"
            VAL="${{ secrets.KICK_USERINFO_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_BOT_SCOPES }}" ]; then
            KEY="KICK_BOT_SCOPES"
            VAL="${{ secrets.KICK_BOT_SCOPES }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_SCOPES }}" ]; then
            KEY="KICK_SCOPES"
            VAL="${{ secrets.KICK_SCOPES }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi

          pnpm install --frozen-lockfile
          pnpm build
          pnpm prisma migrate deploy

          pm2 stop "$PM2_NAME" 2>/dev/null || true
          pm2 delete "$PM2_NAME" 2>/dev/null || true
          pm2 start dist/index.js --name "$PM2_NAME" --update-env
          pm2 save

          echo "Waiting for healthcheck on :3001 ..."
          for i in $(seq 1 30); do
            if curl -fsS --max-time 2 http://127.0.0.1:3001/health >/dev/null; then
              echo "✅ Production deployed"
              exit 0
            fi
            sleep 2
          done

          echo "❌ Healthcheck failed (production). Recent logs:"
          pm2 logs "$PM2_NAME" --lines 120 --nostream || true
          exit 1

  deploy-beta:
    name: Deploy beta on VPS (self-hosted)
    runs-on: [self-hosted, linux, x64, memalerts-vps]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test]
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Need full history for BEFORE..AFTER diff and for scanning commit messages in the push range.
          fetch-depth: 0

      - name: Decide whether to deploy (force or relevant changes)
        id: decide
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # Force deploy if ANY pushed commit message contains "deploy" or "[deploy]"
          # (head_commit.message is not always reliable when multiple commits are pushed at once)
          if [ -n "${{ github.event.head_commit.message }}" ] && echo "${{ github.event.head_commit.message }}" | grep -Eiq '(^|\\s)\\[?deploy\\]?($|\\s)'; then
            echo "Force deploy requested by head commit message."
            echo "deploy=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ -n "$BEFORE" ] && [ "$BEFORE" != "0000000000000000000000000000000000000000" ]; then
            if git log --format=%B "$BEFORE..$AFTER" | grep -Eiq '(^|\\s)\\[?deploy\\]?($|\\s)'; then
              echo "Force deploy requested by commit message in push range."
              echo "deploy=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          # If before is empty (first commit) just proceed.
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "No BEFORE SHA; proceeding with deploy."
            echo "deploy=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check if any relevant paths changed between BEFORE and AFTER.
          if git diff --name-only "$BEFORE" "$AFTER" | grep -Eiq '^(src/|prisma/|package\\.json$|tsconfig\\.json$|\\.github/)'; then
            echo "Relevant changes detected; proceeding with deploy."
            echo "deploy=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "No relevant changes; skipping deploy."
          echo "deploy=false" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Setup pnpm
        if: steps.decide.outputs.deploy == 'true'
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        if: steps.decide.outputs.deploy == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      # DANGEROUS (nuclear): rewrites nginx config and removes other site configs.
      # Run only when explicitly requested via commit message marker.
      - name: Setup nginx full (optional; requires [nginx-full])
        if: steps.decide.outputs.deploy == 'true' && contains(github.event.head_commit.message, '[nginx-full]')
        shell: bash
        run: |
          set -euo pipefail
          sudo bash .github/scripts/setup-nginx-full.sh twitchmemes.ru 3001 3002

      - name: Deploy beta (build + migrate + restart)
        shell: bash
        if: steps.decide.outputs.deploy == 'true'
        run: |
          set -euo pipefail

          APP_DIR="/opt/memalerts-backend-beta"
          PM2_NAME="memalerts-api-beta"

          if [ ! -d "$APP_DIR" ]; then
            echo "❌ $APP_DIR not found. Create it on VPS first."
            exit 1
          fi

          if [ ! -f "$APP_DIR/.env" ]; then
            echo "❌ $APP_DIR/.env not found. Create it on VPS first (beta env, token_beta cookie + JWT_SECRET_BETA, etc)."
            exit 1
          fi

          echo "Syncing repo -> $APP_DIR ..."
          sudo rsync -a --delete \
            --exclude node_modules \
            --exclude uploads \
            --exclude .env \
            ./ "$APP_DIR/"

          cd "$APP_DIR"

          # Optional env sync from GitHub Secrets -> VPS .env (non-destructive upsert).
          # OpenAI (AI moderation) - prefer beta-specific secret when present.
          if [ -n "${{ secrets.AI_MODERATION_ENABLED_BETA || secrets.AI_MODERATION_ENABLED }}" ]; then
            KEY="AI_MODERATION_ENABLED"
            VAL="${{ secrets.AI_MODERATION_ENABLED_BETA || secrets.AI_MODERATION_ENABLED }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.OPENAI_API_KEY_BETA || secrets.OPENAI_API_KEY }}" ]; then
            KEY="OPENAI_API_KEY"
            VAL="${{ secrets.OPENAI_API_KEY_BETA || secrets.OPENAI_API_KEY }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.OPENAI_BASE_URL_BETA || secrets.OPENAI_BASE_URL }}" ]; then
            KEY="OPENAI_BASE_URL"
            VAL="${{ secrets.OPENAI_BASE_URL_BETA || secrets.OPENAI_BASE_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.OPENAI_ASR_MODEL_BETA || secrets.OPENAI_ASR_MODEL }}" ]; then
            KEY="OPENAI_ASR_MODEL"
            VAL="${{ secrets.OPENAI_ASR_MODEL_BETA || secrets.OPENAI_ASR_MODEL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.VKVIDEO_PUBSUB_REFRESH_SECONDS }}" ]; then
            KEY="VKVIDEO_PUBSUB_REFRESH_SECONDS"
            VAL="${{ secrets.VKVIDEO_PUBSUB_REFRESH_SECONDS }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then
              sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"
            else
              echo "${KEY}=${VAL}" >> "$APP_DIR/.env"
            fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi

          # Trovo OAuth (beta; falls back to non-suffixed secrets)
          if [ -n "${{ secrets.TROVO_CLIENT_ID_BETA || secrets.TROVO_CLIENT_ID }}" ]; then
            KEY="TROVO_CLIENT_ID"
            VAL="${{ secrets.TROVO_CLIENT_ID_BETA || secrets.TROVO_CLIENT_ID }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_CLIENT_SECRET_BETA || secrets.TROVO_CLIENT_SECRET }}" ]; then
            KEY="TROVO_CLIENT_SECRET"
            VAL="${{ secrets.TROVO_CLIENT_SECRET_BETA || secrets.TROVO_CLIENT_SECRET }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_CALLBACK_URL_BETA || secrets.TROVO_CALLBACK_URL }}" ]; then
            KEY="TROVO_CALLBACK_URL"
            VAL="${{ secrets.TROVO_CALLBACK_URL_BETA || secrets.TROVO_CALLBACK_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_BOT_SCOPES_BETA || secrets.TROVO_BOT_SCOPES }}" ]; then
            KEY="TROVO_BOT_SCOPES"
            VAL="${{ secrets.TROVO_BOT_SCOPES_BETA || secrets.TROVO_BOT_SCOPES }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_SCOPES_BETA || secrets.TROVO_SCOPES }}" ]; then
            KEY="TROVO_SCOPES"
            VAL="${{ secrets.TROVO_SCOPES_BETA || secrets.TROVO_SCOPES }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_TOKEN_URL_BETA || secrets.TROVO_TOKEN_URL }}" ]; then
            KEY="TROVO_TOKEN_URL"
            VAL="${{ secrets.TROVO_TOKEN_URL_BETA || secrets.TROVO_TOKEN_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_REFRESH_URL_BETA || secrets.TROVO_REFRESH_URL }}" ]; then
            KEY="TROVO_REFRESH_URL"
            VAL="${{ secrets.TROVO_REFRESH_URL_BETA || secrets.TROVO_REFRESH_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.TROVO_USERINFO_URL_BETA || secrets.TROVO_USERINFO_URL }}" ]; then
            KEY="TROVO_USERINFO_URL"
            VAL="${{ secrets.TROVO_USERINFO_URL_BETA || secrets.TROVO_USERINFO_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi

          # Kick OAuth (beta; falls back to non-suffixed secrets)
          if [ -n "${{ secrets.KICK_CLIENT_ID_BETA || secrets.KICK_CLIENT_ID }}" ]; then
            KEY="KICK_CLIENT_ID"
            VAL="${{ secrets.KICK_CLIENT_ID_BETA || secrets.KICK_CLIENT_ID }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_CLIENT_SECRET_BETA || secrets.KICK_CLIENT_SECRET }}" ]; then
            KEY="KICK_CLIENT_SECRET"
            VAL="${{ secrets.KICK_CLIENT_SECRET_BETA || secrets.KICK_CLIENT_SECRET }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_CALLBACK_URL_BETA || secrets.KICK_CALLBACK_URL }}" ]; then
            KEY="KICK_CALLBACK_URL"
            VAL="${{ secrets.KICK_CALLBACK_URL_BETA || secrets.KICK_CALLBACK_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_AUTHORIZE_URL_BETA || secrets.KICK_AUTHORIZE_URL }}" ]; then
            KEY="KICK_AUTHORIZE_URL"
            VAL="${{ secrets.KICK_AUTHORIZE_URL_BETA || secrets.KICK_AUTHORIZE_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_TOKEN_URL_BETA || secrets.KICK_TOKEN_URL }}" ]; then
            KEY="KICK_TOKEN_URL"
            VAL="${{ secrets.KICK_TOKEN_URL_BETA || secrets.KICK_TOKEN_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_REFRESH_URL_BETA || secrets.KICK_REFRESH_URL }}" ]; then
            KEY="KICK_REFRESH_URL"
            VAL="${{ secrets.KICK_REFRESH_URL_BETA || secrets.KICK_REFRESH_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_USERINFO_URL_BETA || secrets.KICK_USERINFO_URL }}" ]; then
            KEY="KICK_USERINFO_URL"
            VAL="${{ secrets.KICK_USERINFO_URL_BETA || secrets.KICK_USERINFO_URL }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_BOT_SCOPES_BETA || secrets.KICK_BOT_SCOPES }}" ]; then
            KEY="KICK_BOT_SCOPES"
            VAL="${{ secrets.KICK_BOT_SCOPES_BETA || secrets.KICK_BOT_SCOPES }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi
          if [ -n "${{ secrets.KICK_SCOPES_BETA || secrets.KICK_SCOPES }}" ]; then
            KEY="KICK_SCOPES"
            VAL="${{ secrets.KICK_SCOPES_BETA || secrets.KICK_SCOPES }}"
            if grep -qE "^${KEY}=" "$APP_DIR/.env"; then sed -i "s|^${KEY}=.*|${KEY}=${VAL}|" "$APP_DIR/.env"; else echo "${KEY}=${VAL}" >> "$APP_DIR/.env"; fi
            echo "✅ Upserted ${KEY} into $APP_DIR/.env"
          fi

          pnpm install --frozen-lockfile
          pnpm build
          pnpm prisma migrate deploy

          pm2 stop "$PM2_NAME" 2>/dev/null || true
          pm2 delete "$PM2_NAME" 2>/dev/null || true
          pm2 start dist/index.js --name "$PM2_NAME" --update-env
          pm2 save

          echo "Waiting for healthcheck on :3002 ..."
          for i in $(seq 1 30); do
            if curl -fsS --max-time 2 http://127.0.0.1:3002/health >/dev/null; then
              echo "✅ Beta deployed"
              exit 0
            fi
            sleep 2
          done

          echo "❌ Healthcheck failed (beta). Recent logs:"
          pm2 logs "$PM2_NAME" --lines 120 --nostream || true
          exit 1


