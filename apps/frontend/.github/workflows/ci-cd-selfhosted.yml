name: Frontend Deploy (Self-hosted)

on:
  push:
    branches: [main]
    tags: ['prod-*']
    paths:
      - 'src/**'
      - 'overlay/**'
      - 'index.html'
      - 'vite.config.ts'
      - 'tsconfig*.json'
      - 'tailwind.config.js'
      - 'postcss.config.js'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - '.github/**'
      - 'docs/**'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-production:
    name: Deploy production on VPS (self-hosted)
    runs-on: [self-hosted, linux, x64, memalerts-vps]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/prod-')
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Deploy production (sync + build + config + nginx)
        shell: bash
        env:
          UPLOADS_BASE_URL: ${{ secrets.UPLOADS_BASE_URL }}
        run: |
          set -euo pipefail

          APP_DIR="/opt/memalerts-frontend"

          if [ ! -d "$APP_DIR" ]; then
            echo "❌ $APP_DIR not found. Create it on VPS first."
            exit 1
          fi

          echo "Syncing repo -> $APP_DIR ..."
          sudo rsync -a --delete \
            --exclude node_modules \
            --exclude dist \
            --exclude overlay/node_modules \
            --exclude overlay/dist \
            --exclude .env \
            ./ "$APP_DIR/"

          cd "$APP_DIR"

          rm -rf dist overlay/dist

          pnpm install --frozen-lockfile
          pnpm lint
          pnpm lint:overlay
          pnpm test:ci
          pnpm build
          pnpm build:overlay

          echo "Writing runtime config: dist/config.json"
          node - <<'NODE'
          const fs = require('fs');
          const cfg = {
            uploadsBaseUrl: process.env.UPLOADS_BASE_URL || "",
            apiBaseUrl: "",
            socketUrl: "",
            publicBaseUrl: "",
          };
          fs.mkdirSync('dist', { recursive: true });
          fs.writeFileSync('dist/config.json', JSON.stringify(cfg, null, 2));
          NODE
          
          echo "Reloading nginx (best-effort)..."
          sudo nginx -t && sudo systemctl reload nginx || true

  deploy-beta:
    name: Deploy beta on VPS (self-hosted)
    runs-on: [self-hosted, linux, x64, memalerts-vps]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Deploy beta (sync + build + config + nginx)
        shell: bash
        env:
          UPLOADS_BASE_URL: ${{ secrets.UPLOADS_BASE_URL_BETA || secrets.UPLOADS_BASE_URL }}
        run: |
          set -euo pipefail

          APP_DIR="/opt/memalerts-frontend-beta"

          if [ ! -d "$APP_DIR" ]; then
            echo "❌ $APP_DIR not found. Create it on VPS first."
            exit 1
          fi

          echo "Syncing repo -> $APP_DIR ..."
          sudo rsync -a --delete \
            --exclude node_modules \
            --exclude dist \
            --exclude overlay/node_modules \
            --exclude overlay/dist \
            --exclude .env \
            ./ "$APP_DIR/"

          cd "$APP_DIR"

          rm -rf dist overlay/dist

          pnpm install --frozen-lockfile
          pnpm lint
          pnpm lint:overlay
          pnpm test:ci
          pnpm build
          pnpm build:overlay

          echo "Writing runtime config: dist/config.json"
          node - <<'NODE'
          const fs = require('fs');
          const cfg = {
            uploadsBaseUrl: process.env.UPLOADS_BASE_URL || "",
            apiBaseUrl: "",
            socketUrl: "",
            publicBaseUrl: "",
          };
          fs.mkdirSync('dist', { recursive: true });
          fs.writeFileSync('dist/config.json', JSON.stringify(cfg, null, 2));
          NODE
          
          echo "Reloading nginx (best-effort)..."
          sudo nginx -t && sudo systemctl reload nginx || true


